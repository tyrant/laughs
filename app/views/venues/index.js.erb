// Update our marker set. We want to add new markers that don't exist on the map yet,
// delete the ones that currently exist there but aren't in our new marker set,
// and do zilch to the markers both on the map and in our new set.

// Actually hold on that, it's unnecessarily fiddly, given we'll be replacing this later.

_(window.markers).each(function(marker) {
  marker.setMap(null);
});

var venuesJson = <%= raw @venues.to_json %>;

// Create our incoming markers.
window.markers = _(venuesJson).map(function(venueJson) {

  var marker = new google.maps.Marker({
    position: new google.maps.LatLng(venueJson.latitude, venueJson.longitude),
    title:    venueJson.name + ', ' + venueJson.readable_address,
    map:      window.map
  });

  // Whenever the user clicks on a marker, we transport them to 
  // /venues/:id-:name/?lat=:lat&lng=:lng&zoom=:z&[form-vars].
  google.maps.event.addListener(marker, 'click', function() {
    window.location.href = '/venues/' + marker.venueJson.to_param + '?lat=' + $.query.get('lat') + '&lng=' + $.query.get('lng') + '&zoom=' + $.query.get('zoom') + '&' + $('#filter').serialize();
  });

  marker.venueJson = venueJson;

  return marker;
});

